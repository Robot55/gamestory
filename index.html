<!DOCTYPE html>
<html>
<head>
<title>Screen Capture</title>
</head>
<body onload="init();" style="background-color:#ababab;" >
<div>
    <div>
      <video id="camFeed" width="1280" height="720" autoplay ></video>
  </div>
</div>
<script>

// uncomment for debug:
// nw.Window.get().showDevTools()





var fs = require("fs");
var imgur = require('imgur-v2');
imgur.setClientId('7e0fd2cc7352032');

var c = 0;

function init() {
	navigator.webkitGetUserMedia({
		audio: false,
		video: {
			mandatory: {
				chromeMediaSource: 'screen',
				maxWidth: 1920,
				maxHeight: 1080
			},
			optional: []

		}
	},
	function (stream) {
		document.getElementById('camFeed').src = webkitURL.createObjectURL(stream);
	},
	function () {
		alert("Error");
	});

}

var option = {
	key: "Ctrl+Shift+A"
};

var shortcut = new nw.Shortcut(option);

nw.App.registerGlobalHotKey(shortcut);

shortcut.on('active', function () {
	var video = document.getElementById('camFeed');
	var canvas = document.createElement('canvas');
	canvas.width = video.videoWidth;
	canvas.height = video.videoHeight;
	var ctx = canvas.getContext('2d');
	ctx.drawImage(video, 0, 0);
	
	var tempfilename = "./tempfile.png"

	var dataurl = canvas.toDataURL();
	dataurl = dataurl.replace(/^data:image\/(png|jpg|jpeg);base64,/, "");
	require("fs").writeFile(tempfilename, dataurl, 'base64', function (err) {
		console.log(err);
		imgur.uploadFile(tempfilename)
		.then(function (json) {
			nw.Shell.openExternal(json.data.link)
	
			fs.unlink(tempfilename);
		})
		.catch (function (err) {
			console.error(err.message);
		});
	});
});

shortcut.on('failed', function (msg) {
	alert(msg);
});

</script>

</body>
</html>
